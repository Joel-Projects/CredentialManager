image: docker:latest
services:
    - docker:dind

stages:
    - build
    - release
    - test
    - sentry_release

variables:
    CONTAINER_BUILD_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    CONTAINER_RELEASE_IMAGE: $CI_REGISTRY_IMAGE:latest

build:
    stage: build
    script:
        - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
        - docker build --pull -t $CONTAINER_BUILD_IMAGE .
        - docker push $CONTAINER_BUILD_IMAGE

release:
    stage: release
    script:
        - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
        - docker pull $CONTAINER_BUILD_IMAGE
        - docker tag $CONTAINER_BUILD_IMAGE $CONTAINER_RELEASE_IMAGE
        - docker push $CONTAINER_RELEASE_IMAGE

test:pytest3.8:
    image: python:3.8
    stage: test
    allow_failure: true
    coverage: '/^TOTAL.*\s+(\d+\%)$/'
    artifacts:
        paths:
            - htmlcov/
    services:
        - postgres:latest
    variables:
        POSTGRES_DB: 'postgres_test'
        POSTGRES_USER: 'postgres'
        POSTGRES_PASSWORD: ''
        POSTGRES_HOST_AUTH_METHOD: 'trust'
        DATABASE_URI: "postgresql://postgres:@postgres:5432/postgres_test"
    script:
        - pip install -r app/requirements.txt -r tests/requirements.txt
        - pytest --cov-report=html --cov=app --cov=tests tests

test:pytest3.7:
    image: python:3.7
    stage: test
    allow_failure: true
    coverage: '/^TOTAL.*\s+(\d+\%)$/'
    artifacts:
        paths:
            - htmlcov/
    services:
        - postgres:latest
    variables:
        POSTGRES_DB: 'postgres_test'
        POSTGRES_USER: 'postgres'
        POSTGRES_PASSWORD: ''
        POSTGRES_HOST_AUTH_METHOD: 'trust'
        DATABASE_URI: "postgresql://postgres:@postgres:5432/postgres_test"
    script:
        - pip install -r app/requirements.txt -r tests/requirements.txt
        - pytest --cov-report=html --cov=app --cov=tests tests

test:pytest3.6:
    image: python:3.6
    stage: test
    allow_failure: true
    coverage: '/^TOTAL.*\s+(\d+\%)$/'
    artifacts:
        paths:
            - htmlcov/
    services:
        - postgres:latest
    variables:
        POSTGRES_DB: 'postgres_test'
        POSTGRES_USER: 'postgres'
        POSTGRES_PASSWORD: ''
        POSTGRES_HOST_AUTH_METHOD: 'trust'
        DATABASE_URI: "postgresql://postgres:@postgres:5432/postgres_test"
    script:
        - pip install -r app/requirements.txt -r tests/requirements.txt
        - pytest --cov-report=html --cov=app --cov=tests tests

test:sonarqube:
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [""]
    stage: test
    allow_failure: true
    variables:
      SONAR_TOKEN: $SONAR_TOKEN
      SONAR_HOST_URL: "https://qube.jesassn.org"
      GIT_DEPTH: 0
    script:
        - echo "sonar-scanner -Dsonar.projectKey=credmgr -Dproject.settings=$CI_PROJECT_DI/sonar-project.properties -Dsonar.qualitygate.wait=true"
        - sonar-scanner -Dsonar.projectKey=credmgr -Dproject.settings=$CI_PROJECT_DI/sonar-project.properties -Dsonar.qualitygate.wait=true
    only:
        - master

sentry_release:
    image: python:latest
    stage: .post
    script:
        - echo "release to sentry"
        - pip install requests
        - export author=$(git show -s --format='%an' HEAD)
        - export email=$(git show -s --format='%ae' HEAD)
        - export message=$(git show -s --format='%s' HEAD)
        - python3 release.py $SENTRY_AUTH_TOKEN $CI_COMMIT_SHA $CI_PROJECT_NAME '$author' $email '$message'
